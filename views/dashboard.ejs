<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <script defer src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
</head>
<body class="bg-body-light">
    <%- include('./partials/restaurant-header') %>
    <div class="container mt-md-5 mt-1 pt-lg-4 pt-5">
        <div class="box mt-4 pt-4">
            <div class="feedback lead fs-5 ms-lg-5"></div>
            <input type="text" class="id" value="<%= user.id %>" style="display: none;">
            <div class="row align-items-center justify-content-center gap-4">
                <h3 class="name ms-lg-5 ps-lg-5 pt-lg-4 pb-lg-3">Welcome back <%= user.name %></h3>
                <div class="card col-lg-3 col-md-5 col-10 p-2 rounded-4 shadow border border-dark-subtle border-1 me-lg-4">
                    <h3 class="card-title text-center">Saved By</h3>
                    <h4 class="fs-4 p-3 text-center text-secondary"><%= number %> <%= number === 1 ? 'user' : 'users' %></h4>
                </div>
                <div class="card col-lg-6 col-md-5 col-10 p-2 rounded-4 shadow border border-dark-subtle border-1 d-flex flex-lg-row align-items-center gap-3">
                    <textarea class="form-control shadow-none outline-none offer fs-5" placeholder="Enter offer" rows="4" style="resize: none;"></textarea>
                    <div class="submit d-none d-lg-block btn btn-dark rounded-pill p-2 fs-5">Submit</div> 
                </div>
                <div class="row">
                    <div class="col justify-content-center align-items-center d-flex">
                        <div class="submit d-lg-none btn btn-dark rounded-pill p-2 fs-5">Submit</div>
                    </div>
                </div>
                <% if (offers) { %>
                    <% offers.forEach(offer => { %>
                        <div class="card col-lg-5 col-md-5 col-10 p-1 rounded-4 shadow border border-dark-subtle border-1 mb-1">
                            <h3 class="card-title text-center">Offer</h3>
                            <h4 class="fs-5 pt-3 text-center text-secondary" style="height: 80px; overflow-y: auto;"><%= offer.description%></h4>
                            <div class="btn btn-danger rounded-pill fs-5 pb-1 modal-btn" style="width: 100px;" id="<%= offer.start %>">Delete</div>
                        </div>
                   <% }); %>
                <% } %>
            </div>
        </div>
        <div class="modal fade" id="staticBackdrop" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
                    <div class="modal-dialog modal-dialog-centered">
                        <div class="modal-content border-0 shadow-lg rounded-3" style="background-color: #fff;">
                        
                        <div class="modal-header border-0 pb-1">
                            <h1 class="modal-title fs-5 fw-semibold text-danger" id="staticBackdropLabel">Delete</h1>
                            <button type="button" class="btn-close shadow-none view" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        
                        <div class="modal-body pb-5 text-secondary text-center fs-5" style="overflow-wrap: anywhere;">Are you sure you want to delete this offer?
                        </div>
                        <div class="btn btn-danger rounded-pill fs-5 mb-3 ms-5 delete" style="width: 100px;">Delete</div>
                        </div>
                    </div>
                </div>
    </div>
</body>
    <script>
        const info = document.querySelector('.feedback')
        const input = document.querySelector('.offer')
        const buttons = document.querySelectorAll('.submit')
        const id = document.querySelector('.id').value
        const removeButtons = document.querySelectorAll('.modal-btn')
        const expire = document.querySelector('.delete')
        let offerId

        async function submit() {
            const offer = {
                description : input.value,
                start : new Date()
            }
            console.log(offer)
            const options = {
                method : 'POST',
                headers : {
                    'Content-type' : 'application/json'
                },
                body : JSON.stringify(offer)
            }
            try {
                const response = await fetch(`/restaurant/offer/${id}`,
                options)
                if(!response.ok) throw new Error('Internal server error')
                    const data = await response.json()
                    info.style.color = 'green'
                    info.textContent = data
                    setTimeout(() => {
                        info.textContent = ""
                        input.value = ""
                        location.assign('/restaurant/page')
                    }, 2500);
            } catch (error) {
                console.log('Error', error)
                info.style.color = 'red'
                info.textContent = 'Failed to update the offer try again later'
                setTimeout(() => {
                    info.textContent = ""
                    input.value = ""
                }, 2500);

            }
        }
        async function expireOffer() {
            const expired = {
                expiry : new Date()
            }
            const options = {
                method : 'POST',
                headers : {
                    'Content-type' : 'application/json'
                },
                body : JSON.stringify(expired)
            }
            try {
                const response = await fetch(`/restaurant/delete/${offerId}`,
                options)
                if(!response.ok) throw new Error('Internal server error')
                    const data = await response.json()
                    info.style.color = 'green'
                    info.textContent = data
                    setTimeout(() => {
                        info.textContent = ""
                        input.value = ""
                        location.assign('/restaurant/page')
                    }, 2500);
            } catch (error) {
                console.log('Error', error)
                info.style.color = 'red'
                info.textContent = 'Failed to delete the offer try again later'
                setTimeout(() => {
                    info.textContent = ""
                    input.value = ""
                }, 2500);

            }
        }
        if(removeButtons) {
            removeButtons.forEach(removeBtn => {
                removeBtn.addEventListener('click', () => {   
                    offerId = removeBtn.id
                    console.log(offerId)         
                    const deleteModal = new bootstrap.Modal(document.getElementById('staticBackdrop'));
                    deleteModal.show();
                })
            })
        }
        buttons.forEach(button => {
            button.onclick = submit
        })
        expire.onclick = expireOffer
    </script>
</html>